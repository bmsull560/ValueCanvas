# ValueCanvas - Supabase Configuration with Session Security
# Phase 1: GoTrue session timeouts and secure cookies

version: "3.8"

services:
  # ============================================================================
  # GoTrue (Auth Service) - Enhanced Security Configuration
  # ============================================================================
  auth:
    image: supabase/gotrue:v2.99.0
    container_name: valuecanvas-auth
    depends_on:
      - db
    restart: unless-stopped
    environment:
      # ========================================================================
      # Session Timeouts (Phase 1 Requirements)
      # ========================================================================
      
      # JWT absolute expiry: 1 hour (3600 seconds)
      GOTRUE_JWT_EXP: "3600"
      
      # Session length: 1 hour
      GOTRUE_SESSION_LENGTH: "3600"
      
      # Refresh token expiry: 1 hour (match absolute timeout)
      GOTRUE_REFRESH_TOKEN_EXPIRY: "3600"
      
      # Idle timeout: 30 minutes (1800 seconds)
      # Note: Not all GoTrue versions support this; enforce in middleware if unavailable
      GOTRUE_SESSION_IDLE_TIMEOUT: "1800"
      
      # ========================================================================
      # Cookie Security (Phase 1 Requirements)
      # ========================================================================
      
      # Secure flag - HTTPS only
      GOTRUE_COOKIE_SECURE: "true"
      
      # HttpOnly flag - Prevent XSS access
      GOTRUE_COOKIE_HTTP_ONLY: "true"
      
      # SameSite policy - CSRF protection
      GOTRUE_COOKIE_SAME_SITE: "strict"
      
      # Cookie domain (update for your domain)
      GOTRUE_COOKIE_DOMAIN: "valuecanvas.example.com"
      
      # Cookie name
      GOTRUE_COOKIE_NAME: "sb-access-token"
      
      # ========================================================================
      # Database Configuration
      # ========================================================================
      
      GOTRUE_DB_DRIVER: "postgres"
      GOTRUE_DB_DATABASE_URL: "postgres://supabase_auth_admin:your-secret-password@db:5432/postgres"
      
      # ========================================================================
      # Site Configuration
      # ========================================================================
      
      GOTRUE_SITE_URL: "https://valuecanvas.example.com"
      GOTRUE_URI_ALLOW_LIST: "https://valuecanvas.example.com,http://localhost:3000"
      
      # ========================================================================
      # Security Settings
      # ========================================================================
      
      # JWT secret (CHANGE THIS!)
      GOTRUE_JWT_SECRET: "your-super-secret-jwt-secret-min-32-characters"
      
      # API secret (CHANGE THIS!)
      GOTRUE_OPERATOR_TOKEN: "your-super-secret-operator-token"
      
      # Disable signup if you want invite-only
      GOTRUE_DISABLE_SIGNUP: "false"
      
      # Email confirmation required
      GOTRUE_MAILER_AUTOCONFIRM: "false"
      
      # Max password length
      GOTRUE_PASSWORD_MIN_LENGTH: "12"

      # Require strong password (explicit flags for GoTrue v2)
      GOTRUE_PASSWORD_REQUIRED_CHARACTERS: "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()"
      GOTRUE_PASSWORD_REQUIRE_SPECIAL_CHARS: "true"
      GOTRUE_PASSWORD_REQUIRE_UPPERCASE: "true"
      GOTRUE_PASSWORD_REQUIRE_LOWERCASE: "true"
      GOTRUE_PASSWORD_REQUIRE_NUMBERS: "true"

      # Enforce MFA at the auth service level
      GOTRUE_MFA_ENABLED: "true"
      GOTRUE_MFA_TOTP_ENABLED: "true"
      GOTRUE_MFA_PHONE_ENABLED: "false"  # Keep SMS off until provider configured
      GOTRUE_MFA_SUPPRESS_CLEAR_CONFIG: "true"  # Prevent silent MFA downgrade
      
      # ========================================================================
      # Rate Limiting (GoTrue built-in)
      # ========================================================================
      
      # Max retries for API calls
      GOTRUE_API_MAX_RETRIES: "1"

      # Rate limit per email (signups/password resets)
      GOTRUE_RATE_LIMIT_EMAIL_SENT: "3"

      # Rate limit window (in seconds)
      GOTRUE_RATE_LIMIT_WINDOW: "3600"  # 1 hour

      # Concurrency limits to slow password spraying
      GOTRUE_MAX_CONCURRENT_SIGNINS: "3"
      GOTRUE_MAX_CONCURRENT_SIGNUPS: "2"
      
      # ========================================================================
      # Logging
      # ========================================================================
      
      GOTRUE_LOG_LEVEL: "info"
      GOTRUE_LOG_FILE: "/var/log/auth.log"
      
    ports:
      - "9999:9999"
    volumes:
      - ./logs/auth:/var/log
    networks:
      - supabase_network

  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  db:
    image: supabase/postgres:15.1.0.117
    container_name: valuecanvas-db
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: your-super-secret-postgres-password
      POSTGRES_DB: postgres
    ports:
      - "54322:5432"
    volumes:
      - ./data/db:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    networks:
      - supabase_network
    command:
      - postgres
      - -c
      - max_connections=200
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB

  # ============================================================================
  # Kong API Gateway (Optional - for additional rate limiting)
  # ============================================================================
  kong:
    image: kong:3.4-alpine
    container_name: valuecanvas-kong
    restart: unless-stopped
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /usr/local/kong/kong.yml
      KONG_PROXY_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_ACCESS_LOG: /dev/stdout
      KONG_PROXY_ERROR_LOG: /dev/stderr
      KONG_ADMIN_ERROR_LOG: /dev/stderr
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
    ports:
      - "8000:8000"   # Proxy
      - "8443:8443"   # Proxy SSL
      - "8001:8001"   # Admin API
    volumes:
      - ./kong.yml:/usr/local/kong/kong.yml:ro
    networks:
      - supabase_network

  # ============================================================================
  # Redis (for session storage and rate limiting)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: valuecanvas-redis
    restart: unless-stopped
    command: redis-server --requirepass your-redis-password --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    networks:
      - supabase_network

networks:
  supabase_network:
    driver: bridge

volumes:
  db_data:
  redis_data:

# ============================================================================
# Usage Instructions
# ============================================================================

# 1. Update secrets in this file:
#    - GOTRUE_JWT_SECRET (min 32 chars)
#    - GOTRUE_OPERATOR_TOKEN
#    - GOTRUE_DB_DATABASE_URL password
#    - POSTGRES_PASSWORD
#    - Redis password

# 2. Update domain:
#    - GOTRUE_COOKIE_DOMAIN
#    - GOTRUE_SITE_URL
#    - GOTRUE_URI_ALLOW_LIST

# 3. Start services:
#    docker-compose -f docker-compose.supabase.yml up -d

# 4. Verify settings:
#    docker logs valuecanvas-auth | grep -i "session\|cookie"

# 5. Test JWT expiry:
#    curl -X POST http://localhost:9999/token \
#      -H "Content-Type: application/json" \
#      -d '{"email":"user@example.com","password":"password"}' \
#      | jq -r '.access_token' \
#      | base64 -d \
#      | jq '.exp - .iat'
#    # Should return approximately 3600

# ============================================================================
# Monitoring
# ============================================================================

# Check session timeout logs:
# docker logs valuecanvas-auth -f | grep -E "session|timeout|expired"

# Monitor rate limiting:
# docker logs valuecanvas-auth -f | grep -E "rate.limit|too.many"

# View active sessions (requires admin access):
# curl -X GET http://localhost:9999/admin/users \
#   -H "Authorization: Bearer $OPERATOR_TOKEN"
