// ValueCanvas Database Schema
// Prisma schema for type-safe database access and migrations
// Compatible with Supabase PostgreSQL

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp"), pgcrypto, pg_trgm, vector]
}

// ============================================
// Tenancy & Core Models
// ============================================

model Organization {
  id        String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name      String    @db.VarChar(255)
  slug      String    @unique @db.VarChar(255)
  tier      Tier      @default(FREE)
  features  Json      @default("{}")
  limits    Json      @default("{\"max_users\": 5, \"max_agents\": 3, \"api_calls_per_month\": 10000}")
  metadata  Json      @default("{}")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  users      User[]
  apiKeys    ApiKey[]
  auditLogs  AuditLog[]
  agents     Agent[]
  models     Model[]
  canvases   Canvas[]
  executions Execution[]

  @@map("organizations")
}

model User {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  email          String    @db.VarChar(255)
  passwordHash   String    @map("password_hash") @db.VarChar(255)
  firstName      String?   @map("first_name") @db.VarChar(100)
  lastName       String?   @map("last_name") @db.VarChar(100)
  role           UserRole  @default(MEMBER)
  status         UserStatus @default(ACTIVE)
  metadata       Json      @default("{}")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  apiKeys      ApiKey[]
  auditLogs    AuditLog[]
  canvases     Canvas[]

  @@unique([organizationId, email])
  @@map("users")
}

model ApiKey {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  keyHash        String    @unique @map("key_hash") @db.VarChar(255)
  name           String    @db.VarChar(255)
  scopes         String[]  @default([])
  rateLimit      Int       @default(1000) @map("rate_limit")
  lastUsedAt     DateTime? @map("last_used_at") @db.Timestamptz(6)
  expiresAt      DateTime? @map("expires_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model AuditLog {
  id             String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organizationId String   @map("organization_id") @db.Uuid
  userId         String?  @map("user_id") @db.Uuid
  action         String   @db.VarChar(100)
  resourceType   String   @map("resource_type") @db.VarChar(100)
  resourceId     String?  @map("resource_id") @db.Uuid
  changes        Json?
  ipAddress      String?  @map("ip_address") @db.Inet
  userAgent      String?  @map("user_agent")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt(sort: Desc)])
  @@index([organizationId, resourceType, resourceId])
  @@map("audit_logs")
}

// ============================================
// Agent Fabric & Orchestration
// ============================================

model Agent {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(255)
  description    String?
  agentType      String    @map("agent_type") @db.VarChar(50)
  config         Json      @default("{}")
  version        Int       @default(1)
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   Execution[]

  @@index([organizationId, agentType])
  @@map("agents")
}

model Execution {
  id             String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organizationId String         @map("organization_id") @db.Uuid
  agentId        String         @map("agent_id") @db.Uuid
  status         ExecutionStatus @default(PENDING)
  input          Json
  output         Json?
  error          String?
  startedAt      DateTime?      @map("started_at") @db.Timestamptz(6)
  completedAt    DateTime?      @map("completed_at") @db.Timestamptz(6)
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agent        Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([agentId, createdAt(sort: Desc)])
  @@map("executions")
}

// ============================================
// Value Canvas Models
// ============================================

model Model {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  name           String    @db.VarChar(255)
  description    String?
  modelType      String    @map("model_type") @db.VarChar(50)
  schema         Json
  version        Int       @default(1)
  isPublished    Boolean   @default(false) @map("is_published")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  canvases     Canvas[]

  @@index([organizationId, modelType])
  @@map("models")
}

model Canvas {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organizationId String    @map("organization_id") @db.Uuid
  modelId        String    @map("model_id") @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  name           String    @db.VarChar(255)
  data           Json      @default("{}")
  version        Int       @default(1)
  isShared       Boolean   @default(false) @map("is_shared")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  model        Model        @relation(fields: [modelId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, userId])
  @@index([modelId])
  @@map("canvases")
}

// ============================================
// Enums
// ============================================

enum Tier {
  FREE
  PRO
  ENTERPRISE

  @@map("tier")
}

enum UserRole {
  ADMIN
  MANAGER
  MEMBER

  @@map("user_role")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  INVITED
  SUSPENDED

  @@map("user_status")
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED

  @@map("execution_status")
}
