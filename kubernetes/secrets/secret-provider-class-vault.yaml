# Kubernetes SecretProviderClass for HashiCorp Vault
# 
# Integrates with Secrets Store CSI Driver to mount secrets from Vault
# into Kubernetes pods without environment variables
# 
# Sprint 3: Kubernetes Integration
# Created: 2024-11-29

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: valuecanvas-secrets-vault
  namespace: production
  labels:
    app: valuecanvas
    component: secrets
    provider: vault
spec:
  provider: vault
  parameters:
    # Vault server address
    vaultAddress: "https://vault.company.com:8200"
    
    # Vault role for Kubernetes authentication
    roleName: "valuecanvas-production"
    
    # Vault namespace (if using Vault Enterprise)
    vaultNamespace: "valuecanvas"
    
    # KV version (v2 recommended)
    vaultKVVersion: "v2"
    
    # Secrets to mount
    objects: |
      # Database credentials
      - objectName: "database-username"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "username"
      
      - objectName: "database-password"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "password"
      
      - objectName: "database-url"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "url"
      
      # API Keys
      - objectName: "together-api-key"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/api_keys"
        secretKey: "TOGETHER_API_KEY"
      
      - objectName: "openai-api-key"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/api_keys"
        secretKey: "OPENAI_API_KEY"
      
      # Supabase credentials
      - objectName: "supabase-url"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_URL"
      
      - objectName: "supabase-anon-key"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_ANON_KEY"
      
      - objectName: "supabase-service-key"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_SERVICE_KEY"
      
      # JWT Secret
      - objectName: "jwt-secret"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/jwt"
        secretKey: "JWT_SECRET"
      
      # Redis URL
      - objectName: "redis-url"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/redis"
        secretKey: "REDIS_URL"
      
      # Slack webhook (optional)
      - objectName: "slack-webhook"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/notifications"
        secretKey: "SLACK_WEBHOOK_URL"
        secretArgs:
          optional: "true"

  # Optional: Sync secrets to Kubernetes secrets
  secretObjects:
  - secretName: valuecanvas-db-credentials
    type: Opaque
    data:
    - objectName: "database-username"
      key: "username"
    - objectName: "database-password"
      key: "password"
    - objectName: "database-url"
      key: "url"
  
  - secretName: valuecanvas-api-keys
    type: Opaque
    data:
    - objectName: "together-api-key"
      key: "TOGETHER_API_KEY"
    - objectName: "openai-api-key"
      key: "OPENAI_API_KEY"

---
# AWS Secrets Manager version (for AWS deployments)
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: valuecanvas-secrets-aws
  namespace: production
  labels:
    app: valuecanvas
    component: secrets
    provider: aws
spec:
  provider: aws
  parameters:
    # AWS region
    region: "us-east-1"
    
    # Secrets to mount
    objects: |
      - objectName: "valuecanvas/production/tenants/{{TENANT_ID}}/config"
        objectType: "secretsmanager"
        objectAlias: "application-secrets"
        jmesPath:
          - path: "TOGETHER_API_KEY"
            objectAlias: "together-api-key"
          - path: "DATABASE_URL"
            objectAlias: "database-url"
          - path: "JWT_SECRET"
            objectAlias: "jwt-secret"

  # Sync to Kubernetes secrets
  secretObjects:
  - secretName: valuecanvas-secrets
    type: Opaque
    data:
    - objectName: "application-secrets"
      key: "config.json"
