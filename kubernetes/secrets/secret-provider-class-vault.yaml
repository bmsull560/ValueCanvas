# Kubernetes SecretProviderClass definitions for HashiCorp Vault and AWS Secrets Manager
#
# Integrates with Secrets Store CSI Driver to mount secrets into pods without
# exposing them as environment variables. Separate resources are provided for
# dev, staging, and production namespaces.
#
# Sprint 3: Kubernetes Integration
# Updated: 2025-02-24

---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: valuecanvas-secrets-dev-vault
  namespace: dev
  labels:
    app: valuecanvas
    component: secrets
    provider: vault
spec:
  provider: vault
  parameters:
    vaultAddress: "https://vault.company.com:8200"
    roleName: "valuecanvas-dev"
    vaultNamespace: "valuecanvas"
    vaultKVVersion: "v2"
    objects: |
      - objectName: "db-username"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "username"
      - objectName: "db-password"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "password"
      - objectName: "db-url"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "url"
      - objectName: "together-api-key"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/api_keys"
        secretKey: "TOGETHER_API_KEY"
      - objectName: "openai-api-key"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/api_keys"
        secretKey: "OPENAI_API_KEY"
      - objectName: "supabase-url"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_URL"
      - objectName: "supabase-anon-key"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_ANON_KEY"
      - objectName: "supabase-service-key"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_SERVICE_KEY"
      - objectName: "jwt-secret"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/jwt"
        secretKey: "JWT_SECRET"
      - objectName: "redis-url"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/redis"
        secretKey: "REDIS_URL"
      - objectName: "slack-webhook"
        secretPath: "secret/data/dev/tenants/{{TENANT_ID}}/notifications"
        secretKey: "SLACK_WEBHOOK_URL"
        secretArgs:
          optional: "true"
  secretObjects:
  - secretName: valuecanvas-db-credentials-dev
    type: Opaque
    data:
    - objectName: "db-username"
      key: "username"
    - objectName: "db-password"
      key: "password"
    - objectName: "db-url"
      key: "url"
  - secretName: valuecanvas-api-keys-dev
    type: Opaque
    data:
    - objectName: "together-api-key"
      key: "TOGETHER_API_KEY"
    - objectName: "openai-api-key"
      key: "OPENAI_API_KEY"

---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: valuecanvas-secrets-staging-vault
  namespace: staging
  labels:
    app: valuecanvas
    component: secrets
    provider: vault
spec:
  provider: vault
  parameters:
    vaultAddress: "https://vault.company.com:8200"
    roleName: "valuecanvas-staging"
    vaultNamespace: "valuecanvas"
    vaultKVVersion: "v2"
    objects: |
      - objectName: "db-username"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "username"
      - objectName: "db-password"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "password"
      - objectName: "db-url"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "url"
      - objectName: "together-api-key"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/api_keys"
        secretKey: "TOGETHER_API_KEY"
      - objectName: "openai-api-key"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/api_keys"
        secretKey: "OPENAI_API_KEY"
      - objectName: "supabase-url"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_URL"
      - objectName: "supabase-anon-key"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_ANON_KEY"
      - objectName: "supabase-service-key"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_SERVICE_KEY"
      - objectName: "jwt-secret"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/jwt"
        secretKey: "JWT_SECRET"
      - objectName: "redis-url"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/redis"
        secretKey: "REDIS_URL"
      - objectName: "slack-webhook"
        secretPath: "secret/data/staging/tenants/{{TENANT_ID}}/notifications"
        secretKey: "SLACK_WEBHOOK_URL"
        secretArgs:
          optional: "true"
  secretObjects:
  - secretName: valuecanvas-db-credentials-staging
    type: Opaque
    data:
    - objectName: "db-username"
      key: "username"
    - objectName: "db-password"
      key: "password"
    - objectName: "db-url"
      key: "url"
  - secretName: valuecanvas-api-keys-staging
    type: Opaque
    data:
    - objectName: "together-api-key"
      key: "TOGETHER_API_KEY"
    - objectName: "openai-api-key"
      key: "OPENAI_API_KEY"

---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: valuecanvas-secrets-production-vault
  namespace: production
  labels:
    app: valuecanvas
    component: secrets
    provider: vault
spec:
  provider: vault
  parameters:
    vaultAddress: "https://vault.company.com:8200"
    roleName: "valuecanvas-production"
    vaultNamespace: "valuecanvas"
    vaultKVVersion: "v2"
    objects: |
      - objectName: "db-username"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "username"
      - objectName: "db-password"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "password"
      - objectName: "db-url"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/database_credentials"
        secretKey: "url"
      - objectName: "together-api-key"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/api_keys"
        secretKey: "TOGETHER_API_KEY"
      - objectName: "openai-api-key"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/api_keys"
        secretKey: "OPENAI_API_KEY"
      - objectName: "supabase-url"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_URL"
      - objectName: "supabase-anon-key"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_ANON_KEY"
      - objectName: "supabase-service-key"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/supabase"
        secretKey: "SUPABASE_SERVICE_KEY"
      - objectName: "jwt-secret"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/jwt"
        secretKey: "JWT_SECRET"
      - objectName: "redis-url"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/redis"
        secretKey: "REDIS_URL"
      - objectName: "slack-webhook"
        secretPath: "secret/data/production/tenants/{{TENANT_ID}}/notifications"
        secretKey: "SLACK_WEBHOOK_URL"
        secretArgs:
          optional: "true"
  secretObjects:
  - secretName: valuecanvas-db-credentials-production
    type: Opaque
    data:
    - objectName: "db-username"
      key: "username"
    - objectName: "db-password"
      key: "password"
    - objectName: "db-url"
      key: "url"
  - secretName: valuecanvas-api-keys-production
    type: Opaque
    data:
    - objectName: "together-api-key"
      key: "TOGETHER_API_KEY"
    - objectName: "openai-api-key"
      key: "OPENAI_API_KEY"

---
# Optional AWS Secrets Manager variants; update region/object names per environment
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: valuecanvas-secrets-production-aws
  namespace: production
  labels:
    app: valuecanvas
    component: secrets
    provider: aws
spec:
  provider: aws
  parameters:
    region: "us-east-1"
    objects: |
      - objectName: "valuecanvas/production/tenants/{{TENANT_ID}}/config"
        objectType: "secretsmanager"
        objectAlias: "application-secrets"
        jmesPath:
          - path: "TOGETHER_API_KEY"
            objectAlias: "together-api-key"
          - path: "DATABASE_URL"
            objectAlias: "db-url"
          - path: "JWT_SECRET"
            objectAlias: "jwt-secret"
  secretObjects:
  - secretName: valuecanvas-secrets-production
    type: Opaque
    data:
    - objectName: "application-secrets"
      key: "config.json"
