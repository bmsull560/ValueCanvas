# ValueCanvas - Nginx Security Headers Configuration
# Phase 1: Gateway-level security headers
# Place this in: /etc/nginx/conf.d/security-headers.conf

# ============================================================================
# SECURITY HEADERS
# ============================================================================

# Content Security Policy (CSP)
# Prevents XSS, clickjacking, and other code injection attacks
add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src 'self'; connect-src 'self' https://*.supabase.co wss://*.supabase.co; font-src 'self' data: https://fonts.gstatic.com; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests" always;

# Strict Transport Security (HSTS)
# Forces HTTPS for 1 year, including subdomains
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# X-Frame-Options
# Prevents clickjacking attacks
add_header X-Frame-Options "DENY" always;

# X-Content-Type-Options
# Prevents MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# Referrer Policy
# Controls referrer information
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# X-XSS-Protection (legacy browsers)
# Enables XSS filter built into most browsers
add_header X-XSS-Protection "1; mode=block" always;

# Permissions Policy (formerly Feature-Policy)
# Restricts browser features
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;

# ============================================================================
# EXAMPLE: Full Nginx Server Block
# ============================================================================

server {
    listen 443 ssl http2;
    server_name valuecanvas.example.com;
    
    # SSL Configuration
    ssl_certificate /etc/ssl/certs/valuecanvas.crt;
    ssl_certificate_key /etc/ssl/private/valuecanvas.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # Include security headers
    include /etc/nginx/conf.d/security-headers.conf;
    
    # Rate limiting for auth endpoints (Phase 1 requirement)
    location ~ ^/auth/(login|register|reset-password) {
        limit_req zone=auth_zone burst=3 nodelay;
        limit_req_status 429;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # API endpoints
    location /api/ {
        limit_req zone=api_zone burst=10 nodelay;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Frontend static files
    location / {
        root /var/www/valuecanvas;
        try_files $uri $uri/ /index.html;
        
        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}

# ============================================================================
# Rate Limiting Configuration (add to http block)
# ============================================================================

# Add to /etc/nginx/nginx.conf in the http {} block:
#
# # Rate limiting zones
# limit_req_zone $binary_remote_addr zone=auth_zone:10m rate=5r/m;  # 5 requests per minute for auth
# limit_req_zone $binary_remote_addr zone=api_zone:10m rate=60r/m;  # 60 requests per minute for API
#
# # Connection limiting
# limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
# limit_conn conn_limit 10;  # Max 10 concurrent connections per IP

# ============================================================================
# Redirect HTTP to HTTPS
# ============================================================================

server {
    listen 80;
    server_name valuecanvas.example.com;
    
    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# ============================================================================
# Verification
# ============================================================================

# Test configuration:
# nginx -t
#
# Reload nginx:
# nginx -s reload
#
# Verify headers:
# curl -I https://valuecanvas.example.com/ | grep -Ei 'content-security-policy|strict-transport-security|x-frame-options'
