# ValueCanvas - Nginx Auth Rate Limiting Configuration
# Phase 1: Per-IP and Per-Tenant Rate Limiting for Auth Routes

# ============================================================================
# Rate Limiting Zones (add to http {} block in nginx.conf)
# ============================================================================

# Per-IP rate limiting
limit_req_zone $binary_remote_addr zone=auth_login_ip:10m rate=5r/m;      # Login: 5 req/min/IP
limit_req_zone $binary_remote_addr zone=auth_signup_ip:10m rate=3r/m;     # Signup: 3 req/min/IP
limit_req_zone $binary_remote_addr zone=auth_reset_ip:10m rate=3r/m;      # Reset: 3 req/min/IP
limit_req_zone $binary_remote_addr zone=api_general:10m rate=60r/m;       # API: 60 req/min/IP

# Per-Tenant rate limiting (using X-Tenant-Id header)
map $http_x_tenant_id $tenant_key {
    default $http_x_tenant_id;
    "" "no-tenant";
}

limit_req_zone $tenant_key zone=auth_login_tenant:10m rate=20r/m;         # Login: 20 req/min/tenant
limit_req_zone $tenant_key zone=auth_signup_tenant:10m rate=10r/m;        # Signup: 10 req/min/tenant
limit_req_zone $tenant_key zone=auth_reset_tenant:10m rate=10r/m;         # Reset: 10 req/min/tenant

# Global burst protection (combination of IP + endpoint)
limit_req_zone $binary_remote_addr$request_uri zone=global_burst:10m rate=100r/m;

# Connection limiting per IP
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ============================================================================
# Rate Limit Status Tracking
# ============================================================================

# Log rate limit events
log_format rate_limit_log '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          'tenant="$http_x_tenant_id" '
                          'rate_limited=$limit_req_status';

# ============================================================================
# Server Block Configuration
# ============================================================================

server {
    listen 443 ssl http2;
    server_name valuecanvas.example.com;
    
    # SSL Configuration
    ssl_certificate /etc/ssl/certs/valuecanvas.crt;
    ssl_certificate_key /etc/ssl/private/valuecanvas.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # Include security headers
    include /etc/nginx/conf.d/security-headers.conf;
    
    # Access log with rate limiting info
    access_log /var/log/nginx/access.log rate_limit_log;
    
    # Global connection limit
    limit_conn conn_limit 20;  # Max 20 concurrent connections per IP
    
    # ========================================================================
    # Auth Routes - Strict Rate Limiting
    # ========================================================================
    
    # Login endpoint - Most strict
    location = /auth/login {
        # Per-IP limit: 5 req/min with burst of 2
        limit_req zone=auth_login_ip burst=2 nodelay;
        
        # Per-Tenant limit: 20 req/min with burst of 5
        limit_req zone=auth_login_tenant burst=5 nodelay;
        
        # Global burst protection
        limit_req zone=global_burst burst=10 nodelay;
        
        # Custom 429 response
        limit_req_status 429;
        
        # Add Retry-After header on 429
        add_header Retry-After "60" always;
        add_header X-RateLimit-Limit "5 per minute per IP, 20 per minute per tenant" always;
        
        # Preserve tenant header
        proxy_set_header X-Tenant-Id $http_x_tenant_id;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Signup endpoint
    location = /auth/signup {
        # Per-IP limit: 3 req/min with burst of 1
        limit_req zone=auth_signup_ip burst=1 nodelay;
        
        # Per-Tenant limit: 10 req/min with burst of 3
        limit_req zone=auth_signup_tenant burst=3 nodelay;
        
        # Global burst protection
        limit_req zone=global_burst burst=10 nodelay;
        
        limit_req_status 429;
        add_header Retry-After "60" always;
        add_header X-RateLimit-Limit "3 per minute per IP, 10 per minute per tenant" always;
        
        proxy_set_header X-Tenant-Id $http_x_tenant_id;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Password reset endpoint
    location = /auth/reset-password {
        # Per-IP limit: 3 req/min with burst of 1
        limit_req zone=auth_reset_ip burst=1 nodelay;
        
        # Per-Tenant limit: 10 req/min with burst of 3
        limit_req zone=auth_reset_tenant burst=3 nodelay;
        
        # Global burst protection
        limit_req zone=global_burst burst=10 nodelay;
        
        limit_req_status 429;
        add_header Retry-After "60" always;
        add_header X-RateLimit-Limit "3 per minute per IP, 10 per minute per tenant" always;
        
        proxy_set_header X-Tenant-Id $http_x_tenant_id;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # All other auth routes (refresh, logout, etc.)
    location /auth/ {
        # Moderate rate limiting
        limit_req zone=auth_login_ip burst=5 nodelay;
        limit_req zone=global_burst burst=10 nodelay;
        
        limit_req_status 429;
        add_header Retry-After "60" always;
        
        proxy_set_header X-Tenant-Id $http_x_tenant_id;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ========================================================================
    # API Routes - Moderate Rate Limiting
    # ========================================================================
    
    location /api/ {
        # General API rate limiting
        limit_req zone=api_general burst=10 nodelay;
        limit_req zone=global_burst burst=20 nodelay;
        
        limit_req_status 429;
        add_header Retry-After "10" always;
        
        proxy_set_header X-Tenant-Id $http_x_tenant_id;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ========================================================================
    # Frontend - No Rate Limiting
    # ========================================================================
    
    location / {
        root /var/www/valuecanvas;
        try_files $uri $uri/ /index.html;
    }
}

# ============================================================================
# Monitoring and Alerting
# ============================================================================

# Monitor rate limit events
# tail -f /var/log/nginx/access.log | grep 'rate_limited=PASSED\|REJECTED\|DELAYED'

# Alert on sustained 429s (example using logrotate + script)
# Create /etc/logrotate.d/nginx-rate-limit-alert:
#
# /var/log/nginx/access.log {
#     postrotate
#         COUNT=$(grep -c "status=429" /var/log/nginx/access.log)
#         if [ $COUNT -gt 100 ]; then
#             echo "ALERT: $COUNT rate limit violations in last hour" | \
#                 mail -s "Rate Limit Alert" admin@example.com
#         fi
#     endscript
# }

# ============================================================================
# Upstream Backend Configuration (add to http {} block)
# ============================================================================

upstream backend {
    server backend-app:3000 max_fails=3 fail_timeout=30s;
    
    # If you have multiple backend instances
    # server backend-app-2:3000 max_fails=3 fail_timeout=30s;
    # server backend-app-3:3000 max_fails=3 fail_timeout=30s;
    
    keepalive 32;
}

# ============================================================================
# Testing Commands
# ============================================================================

# Test login rate limiting (should get 429 after 5 requests)
# for i in {1..10}; do
#   curl -I https://valuecanvas.example.com/auth/login \
#     -H "Content-Type: application/json" \
#     -d '{"email":"test@example.com","password":"test"}' \
#     -w "Request $i: %{http_code}\n"
#   sleep 1
# done

# Test tenant-specific rate limiting
# for i in {1..25}; do
#   curl -I https://valuecanvas.example.com/auth/login \
#     -H "X-Tenant-Id: tenant-123" \
#     -d '{"email":"test@example.com","password":"test"}' \
#     -w "Request $i: %{http_code}\n"
#   sleep 1
# done

# ============================================================================
# Installation
# ============================================================================

# 1. Copy this file to nginx config
# sudo cp nginx-auth-rate-limiting.conf /etc/nginx/conf.d/

# 2. Test configuration
# sudo nginx -t

# 3. Reload nginx
# sudo nginx -s reload

# 4. Monitor rate limiting
# tail -f /var/log/nginx/access.log | grep -E "429|rate_limited"
