# ValueCanvas - Envoy Security Headers Configuration
# Phase 1: Gateway-level security headers
# For Envoy proxy / Envoy Gateway

static_resources:
  listeners:
  - name: main_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 443
    
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: ingress_http
          codec_type: AUTO
          
          # ============================================================
          # Security Headers - Response Headers to Add
          # ============================================================
          local_reply_config:
            mappers:
            - filter:
                status_code_filter:
                  comparison:
                    op: GE
                    value:
                      default_value: 200
                      runtime_key: unused_key
              headers_to_add:
              # Content Security Policy
              - header:
                  key: Content-Security-Policy
                  value: "default-src 'self'; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; script-src 'self'; connect-src 'self' https://*.supabase.co wss://*.supabase.co; font-src 'self' data: https://fonts.gstatic.com; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests"
                append: false
              
              # HSTS
              - header:
                  key: Strict-Transport-Security
                  value: "max-age=31536000; includeSubDomains; preload"
                append: false
              
              # X-Frame-Options
              - header:
                  key: X-Frame-Options
                  value: "DENY"
                append: false
              
              # X-Content-Type-Options
              - header:
                  key: X-Content-Type-Options
                  value: "nosniff"
                append: false
              
              # Referrer Policy
              - header:
                  key: Referrer-Policy
                  value: "strict-origin-when-cross-origin"
                append: false
              
              # X-XSS-Protection
              - header:
                  key: X-XSS-Protection
                  value: "1; mode=block"
                append: false
              
              # Permissions Policy
              - header:
                  key: Permissions-Policy
                  value: "geolocation=(), microphone=(), camera=(), payment=()"
                append: false
          
          # ============================================================
          # Rate Limiting (Phase 1 requirement)
          # ============================================================
          http_filters:
          - name: envoy.filters.http.ratelimit
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ratelimit.v3.RateLimit
              domain: valuecanvas
              stage: 0
              rate_limit_service:
                grpc_service:
                  envoy_grpc:
                    cluster_name: rate_limit_service
                transport_api_version: V3
          
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
          
          route_config:
            name: local_route
            virtual_hosts:
            - name: backend
              domains: ["*"]
              
              # ============================================
              # Rate Limit Policies
              # ============================================
              rate_limits:
              - stage: 0
                actions:
                - request_headers:
                    header_name: ":path"
                    descriptor_key: "path"
              
              routes:
              # Auth endpoints - strict rate limiting
              - match:
                  prefix: "/auth/"
                  runtime_fraction:
                    default_value:
                      numerator: 100
                      denominator: HUNDRED
                route:
                  cluster: backend_cluster
                  rate_limits:
                  - stage: 0
                    actions:
                    - generic_key:
                        descriptor_value: "auth_endpoint"
              
              # API endpoints - moderate rate limiting
              - match:
                  prefix: "/api/"
                route:
                  cluster: backend_cluster
                  rate_limits:
                  - stage: 0
                    actions:
                    - generic_key:
                        descriptor_value: "api_endpoint"
              
              # Frontend - no rate limiting
              - match:
                  prefix: "/"
                route:
                  cluster: frontend_cluster
      
      # TLS Configuration
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext
          common_tls_context:
            tls_certificates:
            - certificate_chain:
                filename: "/etc/ssl/certs/valuecanvas.crt"
              private_key:
                filename: "/etc/ssl/private/valuecanvas.key"
            tls_params:
              tls_minimum_protocol_version: TLSv1_2
              tls_maximum_protocol_version: TLSv1_3
              cipher_suites:
              - "ECDHE-ECDSA-AES128-GCM-SHA256"
              - "ECDHE-RSA-AES128-GCM-SHA256"
              - "ECDHE-ECDSA-AES256-GCM-SHA384"
              - "ECDHE-RSA-AES256-GCM-SHA384"
  
  # ============================================================
  # Clusters (Backend Services)
  # ============================================================
  clusters:
  - name: backend_cluster
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: backend_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: backend
                port_value: 3000
  
  - name: frontend_cluster
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: frontend_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: frontend
                port_value: 80
  
  - name: rate_limit_service
    connect_timeout: 5s
    type: STRICT_DNS
    lb_policy: ROUND_ROBIN
    http2_protocol_options: {}
    load_assignment:
      cluster_name: rate_limit_service
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: ratelimit
                port_value: 8081

# ============================================================
# Admin Interface
# ============================================================
admin:
  access_log_path: /tmp/admin_access.log
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901

# ============================================================
# Verification
# ============================================================
# Test configuration:
# envoy --config-path /etc/envoy/envoy.yaml --mode validate
#
# Start Envoy:
# envoy -c /etc/envoy/envoy.yaml
#
# Verify headers:
# curl -I https://valuecanvas.example.com/ | grep -Ei 'content-security-policy|strict-transport-security'
