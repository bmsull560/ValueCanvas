name: Terraform PR Check

on:
  pull_request:
    paths:
      - 'infrastructure/terraform/**'
      - '.github/workflows/terraform-check.yml'

permissions:
  contents: read
  pull-requests: write  # Required to post comments

env:
  TF_VERSION: '1.5.0'
  AWS_REGION: us-east-1

jobs:
  terraform-check:
    name: Terraform Plan & Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format Check
        id: fmt
        working-directory: ./infrastructure/terraform
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      - name: Terraform Init
        id: init
        working-directory: ./infrastructure/terraform
        run: |
          terraform init -backend=false  # Don't need state for validation
      
      - name: Terraform Validate
        id: validate
        working-directory: ./infrastructure/terraform
        run: terraform validate -no-color
      
      - name: Terraform Plan
        id: plan
        working-directory: ./infrastructure/terraform
        env:
          TF_VAR_environment: staging
          TF_VAR_supabase_url: ${{ secrets.SUPABASE_URL }}
          TF_VAR_supabase_anon_key: ${{ secrets.SUPABASE_ANON_KEY }}
          TF_VAR_supabase_service_key: ${{ secrets.SUPABASE_SERVICE_KEY }}
          TF_VAR_together_api_key: ${{ secrets.TOGETHER_API_KEY }}
          TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          TF_VAR_jwt_secret: ${{ secrets.JWT_SECRET }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
          TF_VAR_acm_certificate_arn: ${{ secrets.ACM_CERTIFICATE_ARN }}
        run: |
          terraform plan -no-color -out=tfplan 2>&1 | tee plan_output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Generate Plan Summary
        id: summary
        if: always()
        working-directory: ./infrastructure/terraform
        run: |
          # Extract key metrics from plan
          if [ -f plan_output.txt ]; then
            RESOURCES_TO_ADD=$(grep -c "will be created" plan_output.txt || echo "0")
            RESOURCES_TO_CHANGE=$(grep -c "will be updated" plan_output.txt || echo "0")
            RESOURCES_TO_DESTROY=$(grep -c "will be destroyed" plan_output.txt || echo "0")
            
            echo "resources_add=$RESOURCES_TO_ADD" >> $GITHUB_OUTPUT
            echo "resources_change=$RESOURCES_TO_CHANGE" >> $GITHUB_OUTPUT
            echo "resources_destroy=$RESOURCES_TO_DESTROY" >> $GITHUB_OUTPUT
            
            # Check for dangerous operations
            if [ "$RESOURCES_TO_DESTROY" -gt 0 ]; then
              echo "has_destroys=true" >> $GITHUB_OUTPUT
            else
              echo "has_destroys=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Post Plan to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        with:
          script: |
            const fs = require('fs');
            const path = './infrastructure/terraform/plan_output.txt';
            
            // Read plan output
            let plan = '';
            try {
              plan = fs.readFileSync(path, 'utf8');
            } catch (error) {
              plan = 'Unable to read plan output';
            }
            
            // Get step results
            const fmt = '${{ steps.fmt.outcome }}';
            const init = '${{ steps.init.outcome }}';
            const validate = '${{ steps.validate.outcome }}';
            const planResult = '${{ steps.plan.outcome }}';
            
            // Get summary metrics
            const resourcesAdd = '${{ steps.summary.outputs.resources_add }}';
            const resourcesChange = '${{ steps.summary.outputs.resources_change }}';
            const resourcesDestroy = '${{ steps.summary.outputs.resources_destroy }}';
            const hasDestroys = '${{ steps.summary.outputs.has_destroys }}';
            
            // Build status indicators
            const fmtIcon = fmt === 'success' ? '‚úÖ' : '‚ùå';
            const initIcon = init === 'success' ? '‚úÖ' : '‚ùå';
            const validateIcon = validate === 'success' ? '‚úÖ' : '‚ùå';
            const planIcon = planResult === 'success' ? '‚úÖ' : '‚ùå';
            
            // Build warning for destructive changes
            let warningSection = '';
            if (hasDestroys === 'true') {
              warningSection = `
            
            ### ‚ö†Ô∏è WARNING: Destructive Changes Detected
            
            This plan will **destroy ${resourcesDestroy} resource(s)**. Please review carefully before merging.
            `;
            }
            
            // Truncate plan if too long (GitHub comment limit is 65536 characters)
            const maxLength = 60000;
            let planOutput = plan;
            let truncated = false;
            
            if (plan.length > maxLength) {
              planOutput = plan.substring(0, maxLength);
              truncated = true;
            }
            
            // Build comment body
            const output = `## Terraform Plan Results üìã
            
            **Environment**: \`staging\`
            **Terraform Version**: \`${{ env.TF_VERSION }}\`
            
            ### Validation Status
            
            | Check | Status |
            |-------|--------|
            | Format | ${fmtIcon} \`terraform fmt\` |
            | Init | ${initIcon} \`terraform init\` |
            | Validate | ${validateIcon} \`terraform validate\` |
            | Plan | ${planIcon} \`terraform plan\` |
            
            ### Resource Changes
            
            | Action | Count |
            |--------|-------|
            | üü¢ Create | ${resourcesAdd} |
            | üü° Update | ${resourcesChange} |
            | üî¥ Destroy | ${resourcesDestroy} |
            ${warningSection}
            
            ### Plan Output
            
            <details>
            <summary>Click to expand full plan</summary>
            
            \`\`\`terraform
            ${planOutput}
            \`\`\`
            
            ${truncated ? '\n‚ö†Ô∏è **Note**: Plan output was truncated. View full output in workflow logs.' : ''}
            
            </details>
            
            ---
            
            **Workflow**: [\`${{ github.workflow }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            **Commit**: \`${{ github.event.pull_request.head.sha }}\`
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => {
              return comment.user.type === 'Bot' && comment.body.includes('Terraform Plan Results');
            });
            
            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: output
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: output
              });
            }
      
      - name: Fail if plan failed
        if: steps.plan.outcome == 'failure'
        run: |
          echo "‚ùå Terraform plan failed. Please review the errors above."
          exit 1
      
      - name: Fail if format check failed
        if: steps.fmt.outcome == 'failure'
        run: |
          echo "‚ùå Terraform format check failed. Run 'terraform fmt -recursive' to fix."
          exit 1
      
      - name: Upload plan artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: |
            infrastructure/terraform/tfplan
            infrastructure/terraform/plan_output.txt
          retention-days: 30
