name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
      confirm:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  validate-input:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        if: github.event.inputs.action == 'apply'
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DEPLOY TO PRODUCTION" ]; then
            echo "‚ùå Confirmation text does not match. Deployment cancelled."
            exit 1
          fi
          echo "‚úÖ Confirmation validated"

      - name: Check AWS Account
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify Production Account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "AWS Account ID: $ACCOUNT_ID"
          
          if [ "$ACCOUNT_ID" != "${{ secrets.AWS_PROD_ACCOUNT_ID }}" ]; then
            echo "‚ùå Wrong AWS account! Expected: ${{ secrets.AWS_PROD_ACCOUNT_ID }}, Got: $ACCOUNT_ID"
            exit 1
          fi
          echo "‚úÖ Correct production AWS account verified"

  deploy-production:
    name: Deploy Production Infrastructure
    runs-on: ubuntu-latest
    needs: validate-input
    environment: 
      name: production
      url: https://app.valuecanvas.com
    
    defaults:
      run:
        working-directory: infrastructure/terraform/environments/production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Create Backup Directory
        run: |
          BACKUP_DIR="../../../backups/$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$BACKUP_DIR"
          echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Backup Current State
        run: |
          if [ -f "terraform.tfstate" ]; then
            cp terraform.tfstate "${{ env.BACKUP_DIR }}/terraform.tfstate.backup"
            echo "‚úÖ State backed up to ${{ env.BACKUP_DIR }}"
          fi

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file=terraform.tfvars \
            -var="db_password=${{ secrets.PROD_DB_PASSWORD }}" \
            -var="supabase_url=${{ secrets.PROD_SUPABASE_URL }}" \
            -var="supabase_anon_key=${{ secrets.PROD_SUPABASE_ANON_KEY }}" \
            -var="supabase_service_key=${{ secrets.PROD_SUPABASE_SERVICE_KEY }}" \
            -var="together_api_key=${{ secrets.PROD_TOGETHER_API_KEY }}" \
            -var="openai_api_key=${{ secrets.PROD_OPENAI_API_KEY }}" \
            -var="jwt_secret=${{ secrets.PROD_JWT_SECRET }}" \
            -var="acm_certificate_arn=${{ secrets.PROD_ACM_CERTIFICATE_ARN }}" \
            -var="datadog_api_key=${{ secrets.DATADOG_API_KEY }}" \
            -out=tfplan \
            -no-color

      - name: Save Plan Output
        run: |
          terraform show -no-color tfplan > plan.txt
          terraform show -json tfplan > "${{ env.BACKUP_DIR }}/tfplan.json"

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: production-tfplan
          path: infrastructure/terraform/environments/production/tfplan
          retention-days: 30

      - name: Create Deployment Summary
        run: |
          echo "## üöÄ Production Deployment Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**AWS Account:** $(aws sts get-caller-identity --query Account --output text)" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Initiated by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -n 50 plan.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Wait for Manual Approval
        if: github.event.inputs.action == 'apply'
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ vars.PRODUCTION_APPROVERS }}
          minimum-approvals: 2
          issue-title: "Production Deployment Approval Required"
          issue-body: |
            ## üö® Production Deployment Approval Required
            
            **Workflow:** ${{ github.workflow }}
            **Run ID:** ${{ github.run_id }}
            **Initiated by:** @${{ github.actor }}
            **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ### Changes
            Review the Terraform plan in the workflow logs.
            
            ### Approval
            This deployment requires approval from at least 2 authorized personnel.
            
            **Authorized Approvers:** ${{ vars.PRODUCTION_APPROVERS }}
            
            Please review carefully before approving.

      - name: Terraform Apply
        if: github.event.inputs.action == 'apply'
        id: apply
        run: |
          echo "üöÄ Applying production infrastructure changes..."
          terraform apply \
            -auto-approve \
            -input=false \
            tfplan

      - name: Save Outputs
        if: steps.apply.outcome == 'success'
        run: |
          terraform output -json > outputs.json
          cp outputs.json "${{ env.BACKUP_DIR }}/outputs.json"
          
          echo "## üìä Production Deployment Outputs" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat outputs.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create Deployment Record
        if: steps.apply.outcome == 'success'
        run: |
          cat > "${{ env.BACKUP_DIR }}/deployment-info.txt" << EOF
          Deployment Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          AWS Account: $(aws sts get-caller-identity --query Account --output text)
          Environment: production
          Deployed By: ${{ github.actor }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          Commit SHA: ${{ github.sha }}
          Terraform Version: ${{ env.TERRAFORM_VERSION }}
          EOF

      - name: Upload Deployment Artifacts
        if: steps.apply.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: production-deployment-${{ github.run_number }}
          path: |
            infrastructure/terraform/environments/production/outputs.json
            ${{ env.BACKUP_DIR }}
          retention-days: 90

      - name: Configure kubectl
        if: steps.apply.outcome == 'success'
        run: |
          aws eks update-kubeconfig \
            --name $(terraform output -raw eks_cluster_name) \
            --region ${{ env.AWS_REGION }}

      - name: Verify Cluster
        if: steps.apply.outcome == 'success'
        run: |
          echo "## üîç Cluster Verification" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          kubectl get namespaces >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Run Smoke Tests
        if: steps.apply.outcome == 'success'
        run: |
          echo "Running smoke tests..."
          # Add smoke test commands here
          kubectl get pods -A
          
      - name: Notify Slack on Success
        if: steps.apply.outcome == 'success'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "‚úÖ PRODUCTION infrastructure deployed successfully",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ Production Deployment Successful"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Timestamp:*\n$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify PagerDuty on Failure
        if: failure()
        uses: PagerDuty/pagerduty-change-events-action@v1
        with:
          integration-key: ${{ secrets.PAGERDUTY_INTEGRATION_KEY }}
          summary: "Production infrastructure deployment failed"
          severity: critical
          source: github-actions
          custom-details: |
            {
              "repository": "${{ github.repository }}",
              "workflow": "${{ github.workflow }}",
              "run_id": "${{ github.run_id }}",
              "actor": "${{ github.actor }}"
            }

      - name: Notify Slack on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "‚ùå PRODUCTION infrastructure deployment FAILED",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üö® Production Deployment Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ github.sha }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Timestamp:*\n$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ö†Ô∏è *Immediate action required!* Check logs and rollback if necessary."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
