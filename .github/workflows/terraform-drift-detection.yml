name: Terraform Drift Detection

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  id-token: write

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  detect-drift-staging:
    name: Detect Drift - Staging
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: infrastructure/terraform/environments/staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Refresh
        run: terraform refresh -var-file=terraform.tfvars
        continue-on-error: true

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          terraform plan \
            -var-file=terraform.tfvars \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="supabase_url=${{ secrets.SUPABASE_URL }}" \
            -var="supabase_anon_key=${{ secrets.SUPABASE_ANON_KEY }}" \
            -var="supabase_service_key=${{ secrets.SUPABASE_SERVICE_KEY }}" \
            -var="together_api_key=${{ secrets.TOGETHER_API_KEY }}" \
            -var="openai_api_key=${{ secrets.OPENAI_API_KEY }}" \
            -var="jwt_secret=${{ secrets.JWT_SECRET }}" \
            -var="acm_certificate_arn=${{ secrets.ACM_CERTIFICATE_ARN }}" \
            -detailed-exitcode \
            -no-color > plan.txt
        continue-on-error: true

      - name: Check for Drift
        id: drift
        run: |
          if [ ${{ steps.plan.outputs.exitcode }} -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Drift detected in staging environment"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No drift detected in staging environment"
          fi

      - name: Create Drift Issue
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('infrastructure/terraform/environments/staging/plan.txt', 'utf8');
            const truncatedPlan = plan.length > 60000 ? plan.substring(0, 60000) + '\n\n... (truncated)' : plan;
            
            const title = 'üîÑ Infrastructure Drift Detected - Staging';
            const body = `## Infrastructure Drift Detected
            
            **Environment:** Staging
            **Detection Time:** ${new Date().toISOString()}
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ### Drift Details
            
            <details><summary>Show Terraform Plan</summary>
            
            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`
            
            </details>
            
            ### Recommended Actions
            
            1. Review the changes above
            2. Determine if drift is expected or requires remediation
            3. If remediation needed, run: \`terraform apply\`
            4. If expected, update Terraform state or configuration
            
            ### Labels
            - \`infrastructure\`
            - \`drift-detection\`
            - \`staging\`
            `;
            
            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift-detection,staging'
            });
            
            if (issues.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['infrastructure', 'drift-detection', 'staging']
              });
            } else {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: body
              });
              
              // Add comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `Drift still detected at ${new Date().toISOString()}`
              });
            }

      - name: Close Drift Issue if Resolved
        if: steps.drift.outputs.drift_detected == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift-detection,staging'
            });
            
            for (const issue of issues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '‚úÖ Drift resolved. Infrastructure is now in sync with Terraform state.'
              });
            }

  detect-drift-production:
    name: Detect Drift - Production
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: infrastructure/terraform/environments/production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Refresh
        run: terraform refresh -var-file=terraform.tfvars
        continue-on-error: true

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          terraform plan \
            -var-file=terraform.tfvars \
            -var="db_password=${{ secrets.PROD_DB_PASSWORD }}" \
            -var="supabase_url=${{ secrets.PROD_SUPABASE_URL }}" \
            -var="supabase_anon_key=${{ secrets.PROD_SUPABASE_ANON_KEY }}" \
            -var="supabase_service_key=${{ secrets.PROD_SUPABASE_SERVICE_KEY }}" \
            -var="together_api_key=${{ secrets.PROD_TOGETHER_API_KEY }}" \
            -var="openai_api_key=${{ secrets.PROD_OPENAI_API_KEY }}" \
            -var="jwt_secret=${{ secrets.PROD_JWT_SECRET }}" \
            -var="acm_certificate_arn=${{ secrets.PROD_ACM_CERTIFICATE_ARN }}" \
            -var="datadog_api_key=${{ secrets.DATADOG_API_KEY }}" \
            -detailed-exitcode \
            -no-color > plan.txt
        continue-on-error: true

      - name: Check for Drift
        id: drift
        run: |
          if [ ${{ steps.plan.outputs.exitcode }} -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Drift detected in production environment"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No drift detected in production environment"
          fi

      - name: Create Critical Drift Issue
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('infrastructure/terraform/environments/production/plan.txt', 'utf8');
            const truncatedPlan = plan.length > 60000 ? plan.substring(0, 60000) + '\n\n... (truncated)' : plan;
            
            const title = 'üö® CRITICAL: Infrastructure Drift Detected - PRODUCTION';
            const body = `## üö® CRITICAL: Production Infrastructure Drift Detected
            
            **Environment:** PRODUCTION
            **Detection Time:** ${new Date().toISOString()}
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Severity:** HIGH
            
            ‚ö†Ô∏è **This requires immediate attention from the DevOps team.**
            
            ### Drift Details
            
            <details><summary>Show Terraform Plan</summary>
            
            \`\`\`terraform
            ${truncatedPlan}
            \`\`\`
            
            </details>
            
            ### Immediate Actions Required
            
            1. üîç **Review** the changes immediately
            2. üîí **Lock** production changes if necessary
            3. üìã **Document** the cause of drift
            4. ‚úÖ **Remediate** or update Terraform configuration
            5. üì¢ **Notify** stakeholders
            
            ### Possible Causes
            
            - Manual changes made via AWS Console
            - Auto-scaling events
            - AWS service updates
            - Terraform state out of sync
            
            ### Labels
            - \`infrastructure\`
            - \`drift-detection\`
            - \`production\`
            - \`critical\`
            
            cc: @${{ vars.PRODUCTION_APPROVERS }}
            `;
            
            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift-detection,production'
            });
            
            if (issues.length === 0) {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['infrastructure', 'drift-detection', 'production', 'critical'],
                assignees: context.payload.repository.owner.login
              });
            } else {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: body
              });
              
              // Add urgent comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `üö® **URGENT:** Drift still detected at ${new Date().toISOString()}\n\nThis issue requires immediate attention!`
              });
            }

      - name: Notify PagerDuty
        if: steps.drift.outputs.drift_detected == 'true'
        uses: PagerDuty/pagerduty-change-events-action@v1
        with:
          integration-key: ${{ secrets.PAGERDUTY_INTEGRATION_KEY }}
          summary: "Production infrastructure drift detected"
          severity: high
          source: terraform-drift-detection
          custom-details: |
            {
              "environment": "production",
              "detection_time": "${{ github.event.repository.updated_at }}",
              "workflow_run": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }

      - name: Notify Slack
        if: steps.drift.outputs.drift_detected == 'true'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "üö® CRITICAL: Production infrastructure drift detected",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üö® Production Infrastructure Drift"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Severity:* HIGH\n*Environment:* Production\n*Detection Time:* ${new Date().toISOString()}\n\n‚ö†Ô∏è Immediate action required!"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Details"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
