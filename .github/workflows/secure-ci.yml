name: Secure CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  security-events: write
  packages: write

env:
  NODE_VERSION: '20'
  CACHE_DIR: ~/.npm

jobs:
  secrets-scan:
    name: Secret scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install git-secrets
        run: |
          curl -s -L https://github.com/awslabs/git-secrets/archive/refs/tags/1.3.0.tar.gz | tar xz
          cd git-secrets-1.3.0 && sudo make install
          git secrets --register-aws
          git secrets --install
      - name: Run git-secrets
        run: git secrets --scan --recursive

      - name: TruffleHog scan
        uses: trufflesecurity/trufflehog@v3
        with:
          path: .
          base: 'HEAD'
          head: ''

  lint:
    needs: secrets-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  typecheck:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm run typecheck

  unit-integration:
    needs: typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm test

  rls-multi-tenant:
    needs: unit-integration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
      - name: Run Supabase RLS tests
        env:
          SUPABASE_TEST_TIMEOUT: 1200
        run: |
          supabase test db --workdir supabase --tests supabase/tests/database/rls_policies.test.sql supabase/tests/database/multi_tenant_rls.test.sql

  dependency-audit:
    needs: rls-multi-tenant
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - name: npm audit (high+)
        run: npm audit --audit-level=high
      - name: Snyk test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "SNYK_TOKEN not set; skipping snyk test" && exit 0
          fi
          npx snyk test --severity-threshold=high

  sbom-and-scan:
    needs: dependency-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          format: spdx-json
          output-file: sbom.spdx.json
      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.21.0
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'
      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-and-trivy
          path: |
            sbom.spdx.json
            trivy-results.sarif

  build:
    needs: sbom-and-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm run build
