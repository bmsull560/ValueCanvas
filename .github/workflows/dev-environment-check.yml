name: Dev Environment Check

# Validates dev environment setup on PRs
# Ensures all developers have consistent environment

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '.devcontainer/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - 'vite.config.ts'
      - 'vitest.config.ts'
  workflow_dispatch:

jobs:
  validate-devcontainer:
    name: Validate Dev Container
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate devcontainer.json
        run: |
          # Check if devcontainer.json is valid JSON
          for file in .devcontainer/*.json; do
            echo "Validating $file..."
            jq empty "$file" || exit 1
          done

      - name: Check Dockerfile syntax
        run: |
          # Validate Dockerfile syntax
          docker run --rm -i hadolint/hadolint < .devcontainer/Dockerfile.optimized || true

      - name: Test dev container build
        run: |
          docker build -f .devcontainer/Dockerfile.optimized -t test-devcontainer .

      - name: Test dev container health
        run: |
          docker run --rm test-devcontainer /usr/local/bin/healthcheck

  validate-dependencies:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Validate package.json
        run: |
          # Check if package.json is valid
          npm pkg get name
          npm pkg get version

      - name: Check for dependency conflicts
        run: |
          npm install --dry-run

      - name: Audit dependencies
        run: |
          npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for outdated dependencies
        run: |
          npm outdated || true

  validate-scripts:
    name: Validate Automation Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check script syntax
        run: |
          # Validate shell scripts
          for script in .devcontainer/scripts/*.sh scripts/dev-automation/*.sh; do
            if [ -f "$script" ]; then
              echo "Checking $script..."
              bash -n "$script" || exit 1
            fi
          done

      - name: Check script permissions
        run: |
          # Ensure scripts are executable
          for script in .devcontainer/scripts/*.sh scripts/dev-automation/*.sh; do
            if [ -f "$script" ] && [ ! -x "$script" ]; then
              echo "âŒ $script is not executable"
              exit 1
            fi
          done

  validate-configuration:
    name: Validate Configuration Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate TypeScript config
        run: |
          # Check if tsconfig.json is valid
          cat tsconfig.json | jq empty

      - name: Validate Vite config
        run: |
          # Check if vite.config.ts exists
          [ -f "vite.config.ts" ] || exit 1

      - name: Validate Vitest config
        run: |
          # Check if vitest.config.ts exists
          [ -f "vitest.config.ts" ] || exit 1

      - name: Validate ESLint config
        run: |
          # Check if ESLint config exists
          [ -f "eslint.config.js" ] || [ -f ".eslintrc.json" ] || exit 1

  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [validate-devcontainer, validate-dependencies, validate-scripts, validate-configuration]
    if: always()
    
    steps:
      - name: Generate report
        run: |
          echo "## Dev Environment Validation Report ðŸ“‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-devcontainer.result }}" == "success" ]; then
            echo "- âœ… Dev Container: Valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Dev Container: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.validate-dependencies.result }}" == "success" ]; then
            echo "- âœ… Dependencies: Valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Dependencies: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.validate-scripts.result }}" == "success" ]; then
            echo "- âœ… Scripts: Valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Scripts: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.validate-configuration.result }}" == "success" ]; then
            echo "- âœ… Configuration: Valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Configuration: Failed" >> $GITHUB_STEP_SUMMARY
          fi
